// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

import { stdStorage, StdStorage } from "forge-std/Test.sol";
import "../BaseTest.test.sol";
import "../../../contracts/mock/MockOracle.sol";
import "../../../contracts/mock/MockTreasury.sol";
import "../../../contracts/mock/MockTokenPermit.sol";
import { MockCorrectVaultManagerLiquidationBoostImmutable, MockIncorrectVaultManagerLiquidationBoostImmutable } from "../../../contracts/mock/MockVaultManagerLiquidationBoostImmutable.sol";
import { MockTreasuryImmutable, TreasuryImmutable, Treasury } from "../../../contracts/mock/MockTreasuryImmutable.sol";
import { IAgToken, AgTokenSideChainImmutable } from "../../../contracts/agToken/AgTokenSidechainImmutable.sol";
import { VaultManagerLiquidationBoostImmutable, VaultParameters } from "../../../contracts/vaultManager/VaultManagerLiquidationBoostImmutable.sol";

contract TreasuryImmutableTest is BaseTest {
    using stdStorage for StdStorage;

    address internal _hacker = address(uint160(uint256(keccak256(abi.encodePacked("hacker")))));
    // you should repace with latest "deployedBytecode" from `VaultManagerLiquidationBoostImmutable`
    bytes32 internal _hashVM =
        keccak256(
            hex"608060405234801561001057600080fd5b50600436106103015760003560e01c8063010db1951461030657806301ffc9a71461032f57806306fdde0314610352578063081812fc14610367578063087a60071461037a578063095ea7b3146103915780630e198f22146103a657806313888565146103af57806323b872dd146103b8578063254cf439146103cb578063307439af146103fd57806334ce998a1461041d57806335836f15146104255780633644e5151461043857806339393ac91461044057806339eb4dc6146104515780633ae2325f146104655780633af32abf146104785780633c2e941b1461049857806342842e0e146104a1578063430c2081146104b45780634f7e43df146104c757806355f804b3146104e15780635c975abb146104f457806361d027b3146105085780636352211e1461051b57806370a082311461052e57806374107543146105415780637aacfffa146105545780637adbf973146104405780637c0f59f4146105905780637c3a00fd146105aa5780637dc0d1d0146105bd5780637e53bd97146105d05780637e56d47c146105e35780637ecebe00146105f6578063835986b41461061f57806389050f1d1461063257806395d89b41146106445780639a3b6f2f1461064c5780639f48118f14610692578063a22cb4651461069d578063af2c8c2e146106b0578063b1511cc9146106b9578063b4bd6f46146106cc578063b88d4fde146106df578063bbcac557146106f2578063bfc7ad2e146106fb578063c13cacae14610704578063c4ae3168146103a4578063c66d8b0114610717578063c87b56dd14610731578063d8dfeb4514610744578063d9b1cb5b14610757578063de1f77651461076c578063de8fc6981461077e578063df011c4114610791578063e182b883146107a4578063e1c84ea4146107b7578063e626648a146107c0578063e985e9c5146107da578063e9cbd822146107ed578063f0f4426014610440578063f51cc7dd14610800578063fad9aba314610813578063fc29b0211461081c578063fd527cf81461082f575b600080fd5b603754610319906001600160a01b031681565b60405161032691906141b0565b60405180910390f35b61034261033d3660046141da565b610837565b6040519015158152602001610326565b61035a6108a4565b6040516103269190614247565b61031961037536600461425a565b610932565b610383603f5481565b604051908152602001610326565b6103a461039f366004614288565b610963565b005b610383603e5481565b61038360415481565b6103a46103c63660046142b4565b6109ef565b603c546103e590600160401b90046001600160401b031681565b6040516001600160401b039091168152602001610326565b61041061040b3660046142f5565b610a23565b6040516103269190614325565b610383610ad5565b61038361043336600461425a565b610b07565b610383610b43565b6103a461044e36600461435e565b50565b603d5461034290600160c01b900460ff1681565b61038361047336600461425a565b610b4d565b61038361048636600461435e565b60446020526000908152604090205481565b61038360455481565b6103a46104af3660046142b4565b610b6e565b6103426104c2366004614288565b610b89565b603d546103e590600160801b90046001600160401b031681565b6103a46104ef366004614430565b610b95565b603d5461034290600160c81b900460ff1681565b603354610319906001600160a01b031681565b61031961052936600461425a565b610c33565b61038361053c36600461435e565b610c3e565b6103a461054f366004614464565b610c83565b61057b61056236600461425a565b6043602052600090815260409020805460019091015482565b60408051928352602083019190915201610326565b603c546103e590600160c01b90046001600160401b031681565b603d546103e5906001600160401b031681565b603654610319906001600160a01b031681565b6103a46105de36600461451c565b610f34565b6104106105f1366004614591565b611125565b61038361060436600461435e565b6001600160a01b03166000908152607f602052604090205490565b6103a461062d366004614655565b6116a6565b610383676765c793fa10079d601a1b81565b61035a6117f7565b61065f61065a36600461476f565b611804565b60405161032691908151815260208083015190820152604080830151908201526060918201519181019190915260800190565b610383633b9aca0081565b6103a46106ab366004614805565b611839565b61038360405481565b6103a46106c736600461425a565b611844565b6103836106da36600461435e565b61190d565b6103a46106ed366004614833565b61191d565b61038360425481565b61038360b65481565b6103a461071236600461489e565b61195a565b603d546103e590600160401b90046001600160401b031681565b61035a61073f36600461425a565b611a17565b603454610319906001600160a01b031681565b6103a46107653660046148ca565b5050505050565b610383676765c793fa10079d601b1b81565b61065f61078c36600461495e565b611b6d565b603c546103e5906001600160401b031681565b6103836107b236600461425a565b6123c8565b61038360395481565b603c546103e590600160801b90046001600160401b031681565b6103426107e83660046149bc565b6123d8565b603554610319906001600160a01b031681565b6103a461080e3660046149ea565b612406565b61038360b45481565b61041061082a366004614a6a565b6126c5565b61057b6126ef565b60006001600160e01b03198216635b5e139f60e01b148061086857506001600160e01b031982166380ac58cd60e01b145b8061088357506001600160e01b0319821663430c208160e01b145b8061089e57506001600160e01b031982166301ffc9a760e01b145b92915050565b607d80546108b190614ac6565b80601f01602080910402602001604051908101604052809291908181526020018280546108dd90614ac6565b801561092a5780601f106108ff5761010080835404028352916020019161092a565b820191906000526020600020905b81548152906001019060200180831161090d57829003601f168201915b505050505081565b600061093d8261281d565b61095a5760405163062a39dd60e11b815260040160405180910390fd5b61089e8261283a565b600061096e82612855565b9050806001600160a01b0316836001600160a01b0316036109a2576040516349fa8bc360e11b815260040160405180910390fd5b336001600160a01b038216148015906109c257506109c081336123d8565b155b156109e05760405163c19f17a960e01b815260040160405180910390fd5b6109ea838361288b565b505050565b33816109fb82826128f9565b610a185760405163c19f17a960e01b815260040160405180910390fd5b610765858585612977565b610a2b6140f9565b60008381526043602090815260409182902082518084018452815481526001909101548183015260365483516315f789a960e21b81529351610ace94929387936001600160a01b03909316926357de26a492600480830193928290030181865afa158015610a9d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610ac19190614afa565b610ac9612a4e565b612be3565b9392505050565b6000676765c793fa10079d601b1b610aeb612a4e565b604054610af89190614b29565b610b029190614b56565b905090565b6000676765c793fa10079d601b1b610b1d612a4e565b600084815260436020526040902060010154610b399190614b29565b61089e9190614b56565b6000610b02612f4c565b603b8181548110610b5d57600080fd5b600091825260209091200154905081565b6109ea8383836040518060200160405280600081525061191d565b6000610ace83836128f9565b60335460405163521d4de960e01b81526001600160a01b039091169063521d4de990610bc59033906004016141b0565b602060405180830381865afa158015610be2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c069190614b6a565b610c2357604051632678482f60e21b815260040160405180910390fd5b6046610c2f8282614bcd565b5050565b600061089e82612855565b60006001600160a01b038216610c675760405163d92e233d60e01b815260040160405180910390fd5b506001600160a01b031660009081526048602052604090205490565b60335460405163521d4de960e01b81526001600160a01b039091169063521d4de990610cb39033906004016141b0565b602060405180830381865afa158015610cd0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610cf49190614b6a565b610d1157604051632678482f60e21b815260040160405180910390fd5b806121a360f11b03610d7457603d546001600160401b03600160401b90910481169083161115610d5457604051637650e96360e11b815260040160405180910390fd5b603c80546001600160401b0319166001600160401b038416179055610eed565b80622a242360e91b03610dd857633b9aca00826001600160401b03161015610daf5760405163da6a17b960e01b815260040160405180910390fd5b603c8054600160401b600160801b031916600160401b6001600160401b03851602179055610eed565b8061212360f11b03610e3b57633b9aca00826001600160401b03161115610e1257604051637650e96360e11b815260040160405180910390fd5b603c8054600160801b600160c01b031916600160801b6001600160401b03851602179055610eed565b806124a960f11b03610e7057610e4f612fb8565b50603d80546001600160401b0319166001600160401b038416179055610eed565b806213531160ea1b03610ed457633b9aca00826001600160401b03161115610eab57604051637650e96360e11b815260040160405180910390fd5b603d8054600160801b600160c01b031916600160801b6001600160401b03851602179055610eed565b60405163e1daa9cf60e01b815260040160405180910390fd5b604080516001600160401b0384168152602081018390527f13b367dac93b85d1ed9b3d8961d8b48e1a677c9800bb1613b4b0416b2d5b61d091015b60405180910390a15050565b60335460405163521d4de960e01b81526001600160a01b039091169063521d4de990610f649033906004016141b0565b602060405180830381865afa158015610f81573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610fa59190614b6a565b610fc257604051632678482f60e21b815260040160405180910390fd5b80518251141580610fed575080600081518110610fe157610fe1614c8c565b60200260200101516000145b8061107c57506001600160a01b0383161580159061107c57508160008151811061101957611019614c8c565b60200260200101518260018151811061103457611034614c8c565b602002602001015111158061107c57508060008151811061105757611057614c8c565b60200260200101518160018151811061107257611072614c8c565b6020026020010151105b1561109a57604051631746545d60e11b815260040160405180910390fd5b603780546001600160a01b0319166001600160a01b03851617905581516110c890603a906020850190614128565b5080516110dc90603b906020840190614128565b50826001600160a01b03167feb74d4d9fea592587c926aeb35eb6a7893fb28db0c1c8eb2eb3c586e7164b76c8383604051611118929190614cdd565b60405180910390a2505050565b61112d6140f9565b6002600154036111585760405162461bcd60e51b815260040161114f90614d02565b60405180910390fd5b6002600155865186518114158061116d575080155b1561118b576040516346282e8d60e01b815260040160405180910390fd5b603660009054906101000a90046001600160a01b03166001600160a01b03166357de26a46040518163ffffffff1660e01b8152600401602060405180830381865afa1580156111de573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112029190614afa565b606083015261120f612fb8565b60808301526040517f965a177723c641ee49150b583a0b9ad4730bb20d3474e00ae5a65e777c00d67b90611244908a90614d39565b60405180910390a160005b81811015611616576000604360008b848151811061126f5761126f614c8c565b6020026020010151815260200190815260200160002060405180604001604052908160008201548152602001600182015481525050905060006112bc823387606001518860800151612be3565b905080604001516000141580156112f0575080604001518a84815181106112e5576112e5614c8c565b602002602001015110155b80611317575080600001518a848151811061130d5761130d614c8c565b6020026020010151115b156113405780600001518a848151811061133357611333614c8c565b6020026020010181815250505b6000856060015182606001516113569190614b29565b603854633b9aca008d878151811061137057611370614c8c565b60200260200101516113829190614b29565b61138c9190614b29565b6113969190614b56565b90506113c48c85815181106113ad576113ad614c8c565b6020026020010151828560000151111561044e5750565b825181106114fa575081516020830151604080546000906113e6908490614d4c565b92505081905550604360008d868151811061140357611403614c8c565b60209081029190910181015182528101919091526040016000908120818155600101819055603d548c51633b9aca0091600160401b90046001600160401b0316908e908890811061145657611456614c8c565b60200260200101516114689190614b29565b6114729190614b56565b905082608001518110611486576000611496565b8083608001516114969190614d4c565b876040018181516114a79190614d5f565b905250508b51600080516020615124833981519152908d90869081106114cf576114cf614c8c565b6020026020010151846020015160006040516114ed93929190614d72565b60405180910390a16115bb565b80604360008e878151811061151157611511614c8c565b6020026020010151815260200190815260200160002060000160008282546115399190614d4c565b925050819055506115b98c858151811061155557611555614c8c565b6020026020010151633b9aca00603d60089054906101000a90046001600160401b03166001600160401b03168e888151811061159357611593614c8c565b60200260200101516115a59190614b29565b6115af9190614b56565b8860800151613059565b505b80866020018181516115cd9190614d5f565b9052508a518b90859081106115e4576115e4614c8c565b6020026020010151866000018181516115fd9190614d5f565b90525061160f9250839150614d8b9050565b905061124f565b50603d54633b9aca009061163a90600160401b90046001600160401b031682614d4c565b83516116469190614b29565b6116509190614b56565b604160008282546116619190614d5f565b909155505060408201516042805460009061167d908490614d5f565b90915550506020820151825161169791908888888861318b565b50600180559695505050505050565b6033546040516333b52a9f60e11b81526001600160a01b039091169063676a553e906116d69033906004016141b0565b602060405180830381865afa1580156116f3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906117179190614b6a565b6117345760405163027f480760e01b815260040160405180910390fd5b6000603c54600090600160801b90046001600160401b031684111561177357603c5461177090600160801b90046001600160401b031685614d4c565b90505b60006117846002633b9aca00614e88565b61179283633b9aca00614d4c565b6117a085633b9aca00614d4c565b6117aa9089614b29565b6117b49190614b29565b6117be9190614b56565b90506117ca8187614d4c565b604160008282546117db9190614d5f565b909155506117ed905087826000613059565b5050505050505050565b607e80546108b190614ac6565b61180c614173565b6040805160008082526020820190925261182e91879187918791879190611b6d565b90505b949350505050565b610c2f338383613295565b60335460405163521d4de960e01b81526001600160a01b039091169063521d4de9906118749033906004016141b0565b602060405180830381865afa158015611891573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906118b59190614b6a565b6118d257604051632678482f60e21b815260040160405180910390fd5b60398190556040518181527fdd63b3dcdbebad734892f7c7a26d0f647fbc7eec973e0775f5229018ac4ab47a9060200160405180910390a150565b600061089e8261334a565b919050565b338261192982826128f9565b6119465760405163c19f17a960e01b815260040160405180910390fd5b6119528686868661340d565b505050505050565b603354604051631c86b03760e31b81526001600160a01b039091169063e43581b89061198a9033906004016141b0565b602060405180830381865afa1580156119a7573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119cb9190614b6a565b6119e857604051633b8d9d7560e21b815260040160405180910390fd5b81831115611a095760405163180d062b60e31b815260040160405180910390fd5b60b49290925560b65560b555565b6060611a228261281d565b611a3f5760405163062a39dd60e11b815260040160405180910390fd5b8160005b8115611a6657611a5281614d8b565b9050611a5f600a83614b56565b9150611a43565b6000816001600160401b03811115611a8057611a8061437b565b6040519080825280601f01601f191660200182016040528015611aaa576020820181803683370190505b5090505b8415611b1557611abf600183614d4c565b9150611acc600a86614e97565b611ad7906030614d5f565b60f81b818381518110611aec57611aec614c8c565b60200101906001600160f81b031916908160001a905350611b0e600a86614b56565b9450611aae565b60468054611b2290614ac6565b9050600003611b405760405180602001604052806000815250611b64565b604681604051602001611b54929190614eab565b6040516020818303038152906040525b95945050505050565b611b75614173565b600260015403611b975760405162461bcd60e51b815260040161114f90614d02565b600260015585518751141580611bac57508651155b15611bca576040516346282e8d60e01b815260040160405180910390fd5b6000806000806000805b8c518110156121315760008d8281518110611bf157611bf1614c8c565b6020026020010151905060006007811115611c0e57611c0e614f32565b816007811115611c2057611c20614f32565b03611c6057611c5a8d8381518110611c3a57611c3a614c8c565b6020026020010151806020019051810190611c559190614f48565b61334a565b50612120565b6002816007811115611c7457611c74614f32565b03611cdd578c8281518110611c8b57611c8b614c8c565b6020026020010151806020019051810190611ca69190614f65565b955092506000839003611cb95760455492505b611cc38386613447565b8488606001818151611cd59190614d5f565b905250612120565b6007816007811115611cf157611cf1614f32565b03611dc95760008060008f8581518110611d0d57611d0d614c8c565b6020026020010151806020019051810190611d289190614f89565b60345460405163d505accf60e01b81526001600160a01b038089166004830152306024830152604482018890526064820187905260ff8616608483015260a4820185905260c48201849052969f50939d50939b509497509550929350169063d505accf9060e401600060405180830381600087803b158015611da957600080fd5b505af1158015611dbd573d6000803e3d6000fd5b50505050505050612120565b86600003611ddc57611dd9612fb8565b96505b6004816007811115611df057611df0614f32565b03611eaa578c8281518110611e0757611e07614c8c565b6020026020010151806020019051810190611e229190614f65565b945092506000839003611e355760455492505b611e40838589613059565b93506000611e5281633b9aca00614d4c565b611e60633b9aca0087614b29565b611e6a9190614b56565b9050611e768582614d4c565b60416000828254611e879190614d5f565b925050819055508089602001818151611ea09190614d5f565b9052506121209050565b85600003611f2c57603660009054906101000a90046001600160a01b03166001600160a01b03166357de26a46040518163ffffffff1660e01b8152600401602060405180830381865afa158015611f05573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611f299190614afa565b95505b6001816007811115611f4057611f40614f32565b03611fbe578c8281518110611f5757611f57614c8c565b6020026020010151806020019051810190611f729190614afa565b925082600003611f825760455492505b611f8d8387896134b3565b80965081955050508488604001818151611fa79190614d5f565b905250602088018051859190611cd5908390614d5f565b6003816007811115611fd257611fd2614f32565b03612035578c8281518110611fe957611fe9614c8c565b60200260200101518060200190518101906120049190614f65565b9550925060008390036120175760455492505b6120238386888a6135bf565b8488604001818151611cd59190614d5f565b600581600781111561204957612049614f32565b036120ae578c828151811061206057612060614c8c565b602002602001015180602001905181019061207b9190614f65565b94509250600083900361208e5760455492505b61209a8385888a613699565b93508388600001818151611cd59190614d5f565b60068160078111156120c2576120c2614f32565b03612120576000808e84815181106120dc576120dc614c8c565b60200260200101518060200190518101906120f79190614fdc565b985091965092509050600085900361210f5760455494505b61211d858383898c8e613734565b50505b5061212a81614d8b565b9050611bd4565b508551602087015110612228578551602087015160009161215191614d4c565b9050866060015187604001511061218857612183876060015188604001516121799190614d4c565b828d8d8d8d61318b565b612222565b80156121f557603554604051630d43af8160e21b81526001600160a01b039091169063350ebe04906121c29084908f90339060040161501a565b600060405180830381600087803b1580156121dc57600080fd5b505af11580156121f0573d6000803e3d6000fd5b505050505b612222333089604001518a6060015161220e9190614d4c565b6034546001600160a01b0316929190613883565b506123b4565b6020860151865160009161223b91614d4c565b6035546040516340c10f1960e01b81529192506001600160a01b0316906340c10f199061226e908d908590600401615039565b600060405180830381600087803b15801561228857600080fd5b505af115801561229c573d6000803e3d6000fd5b505050508660600151876040015111156122e0576122db8a886060015189604001516122c89190614d4c565b6034546001600160a01b031691906138ee565b6123b2565b6000876040015188606001516122f69190614d4c565b905080156123b05788511561239857896001600160a01b031663a5d4096b603560009054906101000a90046001600160a01b0316603460009054906101000a90046001600160a01b03163385878f6040518763ffffffff1660e01b815260040161236596959493929190615052565b600060405180830381600087803b15801561237f57600080fd5b505af1158015612393573d6000803e3d6000fd5b505050505b6034546123b0906001600160a01b0316333084613883565b505b505b505060018055509198975050505050505050565b603a8181548110610b5d57600080fd5b6001600160a01b039182166000908152604a6020908152604080832093909416825291909152205460011490565b834211156124275760405163f87d927160e01b815260040160405180910390fd5b6fa2a8918ca85bafe22016d0b997e4df60600160ff1b0381118061245e57508260ff16601b1415801561245e57508260ff16601c14155b1561247c57604051638baa579f60e01b815260040160405180910390fd5b6000612486612f4c565b6082548989896124958d61390d565b6040805160208101969096526001600160a01b03948516908601529290911660608401521515608083015260a082015260c0810187905260e0016040516020818303038152906040528051906020012060405160200161250c92919061190160f01b81526002810192909252602282015260420190565b604051602081830303815290604052805190602001209050612536886001600160a01b031661280e565b1561261257604080516020810185905280820184905260f886901b6001600160f81b0319166060820152815160418183030181526061820192839052630b135d3f60e11b9092526001600160a01b038a1691631626ba7e9161259c918591606501615094565b602060405180830381865afa1580156125b9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125dd91906150ad565b6001600160e01b031916631626ba7e60e01b1461260d57604051638baa579f60e01b815260040160405180910390fd5b6126ba565b6040805160008082526020820180845284905260ff871692820192909252606081018590526080810184905260019060a0016020604051602081039080840390855afa158015612666573d6000803e3d6000fd5b505050602060405103519050886001600160a01b0316816001600160a01b031614158061269a57506001600160a01b038116155b156126b857604051638baa579f60e01b815260040160405180910390fd5b505b6117ed888888613295565b6126cd6140f9565b6040805160008082526020820190925261182e91879187918791879190611125565b60335460009081906001600160a01b0316331461271f5760405163b90cdbb160e01b815260040160405180910390fd5b612727612fb8565b5050604180546042805460009384905592905591508082106127c05761274d8183614d4c565b6035546033546040516340c10f1960e01b8152929450600093506001600160a01b03918216926340c10f19926127899216908690600401615039565b600060405180830381600087803b1580156127a357600080fd5b505af11580156127b7573d6000803e3d6000fd5b505050506127d1565b6127ca8282614d4c565b9050600091505b60408051838152602081018390527ffeb12225c131aab793a00c5239afb778932d170fa28ce6e9d23703e4bd892121910160405180910390a19091565b6001600160a01b03163b151590565b6000908152604760205260409020546001600160a01b0316151590565b6000908152604960205260409020546001600160a01b031690565b6000818152604760205260409020546001600160a01b0316806119185760405163062a39dd60e11b815260040160405180910390fd5b600081815260496020526040902080546001600160a01b0319166001600160a01b03841690811790915581906128c082612855565b6001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45050565b60008061290583612855565b9050806001600160a01b0316846001600160a01b031614806129405750836001600160a01b03166129358461283a565b6001600160a01b0316145b8061183157506001600160a01b038082166000908152604a6020908152604080832093881683529290522054600114949350505050565b826001600160a01b031661298a82612855565b6001600160a01b0316146129b15760405163c19f17a960e01b815260040160405180910390fd5b6001600160a01b0382166129d85760405163d92e233d60e01b815260040160405180910390fd5b6129e360008261288b565b6001600160a01b038084166000818152604860209081526040808320805460001901905593861680835284832080546001019055858352604790915283822080546001600160a01b0319168217905592518493929160008051602061516483398151915291a4505050565b600080603e5442612a5f9190614d4c565b603d549091506001600160401b0316811580612a79575080155b15612a8857603f549250505090565b6000612a95600184614d4c565b9050600060028411612aa8576000612ab3565b612ab3600285614d4c565b90506000676765c793fa10079d601b1b676765c793fa10079d601a1b612ad98680614b29565b612ae39190614d5f565b612aed9190614b56565b90506000676765c793fa10079d601b1b676765c793fa10079d601a1b612b138785614b29565b612b1d9190614d5f565b612b279190614b56565b90506000600283612b38878a614b29565b612b429190614b29565b612b4c9190614b56565b9050600060068386612b5e898c614b29565b612b689190614b29565b612b729190614b29565b612b7c9190614b56565b9050676765c793fa10079d601b1b8183612b968b8b614b29565b612bab90676765c793fa10079d601b1b614d5f565b612bb59190614d5f565b612bbf9190614d5f565b603f54612bcc9190614b29565b612bd69190614b56565b9850505050505050505090565b612beb6140f9565b6000806000612bfb888787613951565b925092509250633b9aca008310612c25576040516315fe9b6160e21b815260040160405180910390fd5b6000633b9aca00612c368582614d4c565b612c3f8a6139dd565b612c499190614b29565b612c539190614b56565b603d54909150600160801b90046001600160401b0316811015612c8357612c7e81633b9aca00614d4c565b612ca4565b603d54612ca490600160801b90046001600160401b0316633b9aca00614d4c565b603d54909150600160401b90046001600160401b0316600080612ccc6002633b9aca00614e88565b603c54612ce291906001600160401b0316614b29565b83612ced868a614b29565b612cf79190614b29565b10612e7c57603c546001600160401b0316612d176002633b9aca00614e88565b612d219190614b29565b603c548590612d4090600160401b90046001600160401b031686614b29565b612d4a9190614b29565b612d549190614d4c565b603c548590633b9aca0090612d72906001600160401b031689614b29565b603c54612d90908b90600160401b90046001600160401b0316614b29565b612d9a9190614d4c565b612da49190614b29565b612dae9190614b29565b612db89190614b56565b60b654909250612dcc633b9aca0082614b29565b612dd68585614b29565b612de09190614d5f565b612dee633b9aca0089614b29565b11612e7657612e08676765c793fa10079d601b1b85614b29565b633b9aca008b8f60200151612e1d9190614b29565b612e279190614b29565b612e319190614b56565b612e3c906001614d5f565b925080871115612e715783633b9aca00612e56838a614d4c565b612e609190614b29565b612e6a9190614b56565b9150612e76565b600191505b50612efa565b603854612e8d90633b9aca00614b29565b8c518b90612e9c908790614b29565b612ea69190614b29565b612eb09190614b56565b612ebb906001614d5f565b915060b554851115612ef657633b9aca008460b55487612edb9190614d4c565b612ee59190614b29565b612eef9190614b56565b9050612efa565b5060015b818852612f07848b614b29565b603854612f18633b9aca0085614b29565b612f229190614b29565b612f2c9190614b56565b602089015260408801525050606085015250608083015250949350505050565b60808054608154604080517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f602082015290810192909252606082015246918101919091523060a082015260009060c00160405160208183030381529060405280519060200120905090565b6000612fc2612a4e565b90506000676765c793fa10079d601b1b603f5483612fe09190614d4c565b604054612fed9190614b29565b612ff79190614b56565b9050806041600082825461300b9190614d5f565b9091555050603f82905542603e8190556040805184815260208101929092527fd1fa8ba00a3bf20274346919dce0de62d2a140af2c71fe7e29fa6472eea3bb9d910160405180910390a15090565b60008160000361306e5761306b612fb8565b91505b60008481526043602052604081206001015490676765c793fa10079d601b1b6130978584614b29565b6130a19190614b56565b90508085106130b2579350806130d5565b836130c8676765c793fa10079d601b1b87614b29565b6130d29190614b56565b90505b6130df8183614d4c565b915080604060008282546130f39190614d4c565b909155505081158015906131285750676765c793fa10079d601b1b60b45461311b9190614b29565b6131258584614b29565b11155b156131465760405163228af07f60e21b815260040160405180910390fd5b60008681526043602052604080822060010184905551600080516020615124833981519152916131799189918591614d72565b60405180910390a15092949350505050565b85156131a8576034546131a8906001600160a01b031684886138ee565b8415611952578051156132275760345460355460405163a5d4096b60e01b81526001600160a01b038086169363a5d4096b936131f49391831692169089908b908d908990600401615052565b600060405180830381600087803b15801561320e57600080fd5b505af1158015613222573d6000803e3d6000fd5b505050505b603554604051630d43af8160e21b81526001600160a01b039091169063350ebe049061325b9088908890339060040161501a565b600060405180830381600087803b15801561327557600080fd5b505af1158015613289573d6000803e3d6000fd5b50505050505050505050565b826001600160a01b0316826001600160a01b0316036132c7576040516320c5195360e21b815260040160405180910390fd5b6000816132d55760006132d8565b60015b6001600160a01b038581166000818152604a602090815260408083209489168084529482529182902060ff959095169485905590518615158152939450919290917f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a350505050565b60006001600160a01b0382166133735760405163d92e233d60e01b815260040160405180910390fd5b5060458054600101908190556001600160a01b038216600081815260486020908152604080832080546001019055848352604790915280822080546001600160a01b031916841790555183929190600080516020615164833981519152908290a46133f06000838360405180602001604052806000815250613c0c565b611918576040516320149b4360e21b815260040160405180910390fd5b613418848484612977565b61342484848484613c0c565b613441576040516320149b4360e21b815260040160405180910390fd5b50505050565b6134508261281d565b61346d5760405163062a39dd60e11b815260040160405180910390fd5b6000828152604360205260408120805483929061348b908490614d5f565b909155505060405160008051602061514483398151915290610f289084908490600190614d72565b60008033856134c282826128f9565b6134df5760405163c19f17a960e01b815260040160405180910390fd5b600087815260436020908152604080832081518083019092528054825260010154918101919091529080613514838a8a613951565b5091509150633b9aca00821161353d57604051631527804d60e31b815260040160405180910390fd5b8260200151604060008282546135539190614d4c565b9091555061356290508a613d12565b600061357281633b9aca00614d4c565b613580633b9aca0084614b29565b61358a9190614b56565b90506135968282614d4c565b604160008282546135a79190614d5f565b90915550509251929a92995091975050505050505050565b33846135cb82826128f9565b6135e85760405163c19f17a960e01b815260040160405180910390fd5b60008681526043602052604081208054879290613606908490614d4c565b90915550506000868152604360209081526040808320815180830190925280548252600101549181019190915261363e908686613951565b50509050633b9aca00811161366657604051631527804d60e31b815260040160405180910390fd5b6000805160206151448339815191528787600060405161368893929190614d72565b60405180910390a150505050505050565b600033856136a782826128f9565b6136c45760405163c19f17a960e01b815260040160405180910390fd5b6136d087878787613d91565b603c54909650600090633b9aca00906136fa908990600160801b90046001600160401b0316614b29565b6137049190614b56565b905080604160008282546137189190614d5f565b9091555061372890508188614d4c565b98975050505050505050565b338661374082826128f9565b61375d5760405163c19f17a960e01b815260040160405180910390fd5b60408051898152602081018890526001600160a01b038916818301526060810187905290517fddd3b70af631334f7552aadb582ed091018e62e103fa8b150ca66cc700d4dac69181900360800190a16137b888868686613d91565b9450306001600160a01b038816036137db576137d5868685613059565b506117ed565b866001600160a01b031663835986b48787603c60109054906101000a90046001600160401b031661380a600090565b6040516001600160e01b031960e087901b168152600481019490945260248401929092526001600160401b039081166044840152166064820152608401600060405180830381600087803b15801561386157600080fd5b505af1158015613875573d6000803e3d6000fd5b505050505050505050505050565b6040516001600160a01b03808516602483015283166044820152606481018290526134419085906323b872dd60e01b906084015b60408051601f198184030181529190526020810180516001600160e01b03166001600160e01b031990931692909217909152613f25565b6109ea8363a9059cbb60e01b84846040516024016138b7929190615039565b6001600160a01b0381166000908152607f6020526040902054613931816001614d5f565b6001600160a01b039092166000908152607f602052604090209190915590565b6000806000676765c793fa10079d601b1b8487602001516139729190614b29565b61397c9190614b56565b91506038548587600001516139919190614b29565b61399b9190614b56565b9050816000036139af5760001992506139d4565b603c5482906139c7906001600160401b031683614b29565b6139d19190614b56565b92505b93509350939050565b6037546000906001600160a01b0316613a1657603b600081548110613a0457613a04614c8c565b90600052602060002001549050919050565b603754604051635dfba04560e11b81526000916001600160a01b03169063bbf7408a90613a479086906004016141b0565b602060405180830381865afa158015613a64573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190613a889190614afa565b9050603a600181548110613a9e57613a9e614c8c565b90600052602060002001548110613ad657603b600181548110613ac357613ac3614c8c565b9060005260206000200154915050919050565b603a600081548110613aea57613aea614c8c565b90600052602060002001548111613b0f57603b600081548110613ac357613ac3614c8c565b603a600081548110613b2357613b23614c8c565b9060005260206000200154603a600181548110613b4257613b42614c8c565b9060005260206000200154613b579190614d4c565b603a600081548110613b6b57613b6b614c8c565b906000526020600020015482613b819190614d4c565b603b600081548110613b9557613b95614c8c565b9060005260206000200154603b600181548110613bb457613bb4614c8c565b9060005260206000200154613bc99190614d4c565b613bd39190614b29565b613bdd9190614b56565b603b600081548110613bf157613bf1614c8c565b9060005260206000200154610ace9190614d5f565b50919050565b6000613c20846001600160a01b031661280e565b15613d0a57604051630a85bd0160e11b81526001600160a01b0385169063150b7a0290613c579033908990889088906004016150ca565b6020604051808303816000875af1925050508015613c92575060408051601f3d908101601f19168201909252613c8f918101906150ad565b60015b613cf0573d808015613cc0576040519150601f19603f3d011682016040523d82523d6000602084013e613cc5565b606091505b508051600003613ce8576040516320149b4360e21b815260040160405180910390fd5b805181602001fd5b6001600160e01b031916630a85bd0160e11b149050611831565b506001611831565b6000613d1d82612855565b9050613d2a60008361288b565b6001600160a01b038116600081815260486020908152604080832080546000190190558583526047825280832080546001600160a01b0319169055604390915280822082815560010182905551849290600080516020615164833981519152908390a45050565b60008082613daa676765c793fa10079d601b1b87614b29565b613db49190614b56565b60008781526043602052604081206001015491925003613df05760b4548511613df05760405163228af07f60e21b815260040160405180910390fd5b60008681526043602052604081206001018054839290613e11908490614d5f565b925050819055508060406000828254613e2a9190614d5f565b9091555050603954613e4890676765c793fa10079d601b1b90614b29565b83604054613e569190614b29565b1115613e75576040516371239a6160e11b815260040160405180910390fd5b60008681526043602090815260408083208151808301909252805482526001015491810191909152613ea8908686613951565b50509050633b9aca008111613ed057604051631527804d60e31b815260040160405180910390fd5b60008051602061512483398151915287836001604051613ef293929190614d72565b60405180910390a1676765c793fa10079d601b1b613f108584614b29565b613f1a9190614b56565b979650505050505050565b6000613f7a826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b0316613ff79092919063ffffffff16565b8051909150156109ea5780806020019051810190613f989190614b6a565b6109ea5760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b606482015260840161114f565b606061183184846000858561400b8561280e565b6140575760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161114f565b600080866001600160a01b031685876040516140739190615107565b60006040518083038185875af1925050503d80600081146140b0576040519150601f19603f3d011682016040523d82523d6000602084013e6140b5565b606091505b5091509150613f1a828286606083156140cf575081610ace565b8251156140df5782518084602001fd5b8160405162461bcd60e51b815260040161114f9190614247565b6040518060a0016040528060008152602001600081526020016000815260200160008152602001600081525090565b828054828255906000526020600020908101928215614163579160200282015b82811115614163578251825591602001919060010190614148565b5061416f92915061419b565b5090565b6040518060800160405280600081526020016000815260200160008152602001600081525090565b5b8082111561416f576000815560010161419c565b6001600160a01b0391909116815260200190565b6001600160e01b03198116811461044e57600080fd5b6000602082840312156141ec57600080fd5b8135610ace816141c4565b60005b838110156142125781810151838201526020016141fa565b50506000910152565b600081518084526142338160208601602086016141f7565b601f01601f19169290920160200192915050565b602081526000610ace602083018461421b565b60006020828403121561426c57600080fd5b5035919050565b6001600160a01b038116811461044e57600080fd5b6000806040838503121561429b57600080fd5b82356142a681614273565b946020939093013593505050565b6000806000606084860312156142c957600080fd5b83356142d481614273565b925060208401356142e481614273565b929592945050506040919091013590565b6000806040838503121561430857600080fd5b82359150602083013561431a81614273565b809150509250929050565b60a0810161089e828480518252602081015160208301526040810151604083015260608101516060830152608081015160808301525050565b60006020828403121561437057600080fd5b8135610ace81614273565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f191681016001600160401b03811182821017156143b9576143b961437b565b604052919050565b600082601f8301126143d257600080fd5b81356001600160401b038111156143eb576143eb61437b565b6143fe601f8201601f1916602001614391565b81815284602083860101111561441357600080fd5b816020850160208301376000918101602001919091529392505050565b60006020828403121561444257600080fd5b81356001600160401b0381111561445857600080fd5b611831848285016143c1565b6000806040838503121561447757600080fd5b82356001600160401b03811681146142a657600080fd5b60006001600160401b038211156144a7576144a761437b565b5060051b60200190565b600082601f8301126144c257600080fd5b813560206144d76144d28361448e565b614391565b82815260059290921b840181019181810190868411156144f657600080fd5b8286015b8481101561451157803583529183019183016144fa565b509695505050505050565b60008060006060848603121561453157600080fd5b833561453c81614273565b925060208401356001600160401b038082111561455857600080fd5b614564878388016144b1565b9350604086013591508082111561457a57600080fd5b50614587868287016144b1565b9150509250925092565b60008060008060008060c087890312156145aa57600080fd5b86356001600160401b03808211156145c157600080fd5b6145cd8a838b016144b1565b975060208901359150808211156145e357600080fd5b6145ef8a838b016144b1565b96506040890135915061460182614273565b90945060608801359061461382614273565b90935060808801359061462582614273565b90925060a0880135908082111561463b57600080fd5b5061464889828a016143c1565b9150509295509295509295565b6000806000806080858703121561466b57600080fd5b5050823594602084013594506040840135936060013592509050565b600082601f83011261469857600080fd5b813560206146a86144d28361448e565b82815260059290921b840181019181810190868411156146c757600080fd5b8286015b84811015614511578035600881106146e35760008081fd5b83529183019183016146cb565b600082601f83011261470157600080fd5b813560206147116144d28361448e565b82815260059290921b8401810191818101908684111561473057600080fd5b8286015b848110156145115780356001600160401b038111156147535760008081fd5b6147618986838b01016143c1565b845250918301918301614734565b6000806000806080858703121561478557600080fd5b84356001600160401b038082111561479c57600080fd5b6147a888838901614687565b955060208701359150808211156147be57600080fd5b506147cb878288016146f0565b93505060408501356147dc81614273565b915060608501356147ec81614273565b939692955090935050565b801515811461044e57600080fd5b6000806040838503121561481857600080fd5b823561482381614273565b9150602083013561431a816147f7565b6000806000806080858703121561484957600080fd5b843561485481614273565b9350602085013561486481614273565b92506040850135915060608501356001600160401b0381111561488657600080fd5b614892878288016143c1565b91505092959194509250565b6000806000606084860312156148b357600080fd5b505081359360208301359350604090920135919050565b60008060008060008587036101808112156148e457600080fd5b86356148ef81614273565b955060208701356148ff81614273565b9450604087013561490f81614273565b9350610100605f198201121561492457600080fd5b506060860191506101608601356001600160401b0381111561494557600080fd5b614951888289016143c1565b9150509295509295909350565b60008060008060008060c0878903121561497757600080fd5b86356001600160401b038082111561498e57600080fd5b61499a8a838b01614687565b975060208901359150808211156149b057600080fd5b6145ef8a838b016146f0565b600080604083850312156149cf57600080fd5b82356149da81614273565b9150602083013561431a81614273565b600080600080600080600060e0888a031215614a0557600080fd5b8735614a1081614273565b96506020880135614a2081614273565b95506040880135614a30816147f7565b945060608801359350608088013560ff81168114614a4d57600080fd5b9699959850939692959460a0840135945060c09093013592915050565b60008060008060808587031215614a8057600080fd5b84356001600160401b0380821115614a9757600080fd5b614aa3888389016144b1565b95506020870135915080821115614ab957600080fd5b506147cb878288016144b1565b600181811c90821680614ada57607f821691505b602082108103613c0657634e487b7160e01b600052602260045260246000fd5b600060208284031215614b0c57600080fd5b5051919050565b634e487b7160e01b600052601160045260246000fd5b808202811582820484141761089e5761089e614b13565b634e487b7160e01b600052601260045260246000fd5b600082614b6557614b65614b40565b500490565b600060208284031215614b7c57600080fd5b8151610ace816147f7565b601f8211156109ea57600081815260208120601f850160051c81016020861015614bae5750805b601f850160051c820191505b8181101561195257828155600101614bba565b81516001600160401b03811115614be657614be661437b565b614bfa81614bf48454614ac6565b84614b87565b602080601f831160018114614c2f5760008415614c175750858301515b600019600386901b1c1916600185901b178555611952565b600085815260208120601f198616915b82811015614c5e57888601518255948401946001909101908401614c3f565b5085821015614c7c5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052603260045260246000fd5b600081518084526020808501945080840160005b83811015614cd257815187529582019590820190600101614cb6565b509495945050505050565b604081526000614cf06040830185614ca2565b8281036020840152611b648185614ca2565b6020808252601f908201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00604082015260600190565b602081526000610ace6020830184614ca2565b8181038181111561089e5761089e614b13565b8082018082111561089e5761089e614b13565b928352602083019190915260ff16604082015260600190565b600060018201614d9d57614d9d614b13565b5060010190565b600181815b80851115614ddf578160001904821115614dc557614dc5614b13565b80851615614dd257918102915b93841c9390800290614da9565b509250929050565b600082614df65750600161089e565b81614e035750600061089e565b8160018114614e195760028114614e2357614e3f565b600191505061089e565b60ff841115614e3457614e34614b13565b50506001821b61089e565b5060208310610133831016604e8410600b8410161715614e62575081810a61089e565b614e6c8383614da4565b8060001904821115614e8057614e80614b13565b029392505050565b6000610ace60ff841683614de7565b600082614ea657614ea6614b40565b500690565b6000808454614eb981614ac6565b60018281168015614ed15760018114614ee657614f15565b60ff1984168752821515830287019450614f15565b8860005260208060002060005b85811015614f0c5781548a820152908401908201614ef3565b50505082870194505b505050508351614f298183602088016141f7565b01949350505050565b634e487b7160e01b600052602160045260246000fd5b600060208284031215614f5a57600080fd5b8151610ace81614273565b60008060408385031215614f7857600080fd5b505080516020909101519092909150565b60008060008060008060c08789031215614fa257600080fd5b8651614fad81614273565b6020880151604089015160608a015160808b015160a0909b0151939c929b509099909850965090945092505050565b60008060008060808587031215614ff257600080fd5b84519350602085015161500481614273565b6040860151606090960151949790965092505050565b9283526001600160a01b03918216602084015216604082015260600190565b6001600160a01b03929092168252602082015260400190565b6001600160a01b038781168252868116602083015285166040820152606081018490526080810183905260c060a082018190526000906137289083018461421b565b828152604060208201526000611831604083018461421b565b6000602082840312156150bf57600080fd5b8151610ace816141c4565b6001600160a01b03858116825284166020820152604081018390526080606082018190526000906150fd9083018461421b565b9695505050505050565b600082516151198184602087016141f7565b919091019291505056fe70cf49afe7355562d5b022e594790f22b71ad8cc7eec902fa5feac7c67f71091722cb71fa87c947148cefc06dd890af5802a6a00207c5ddecf1191bf71ce3cd4ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa2646970667358221220e59f94ab826df3aef4dcca1c7263b3c9c4cf503c792ab064f746ab7df9344dde64736f6c63430008110033"
        );

    VaultParameters internal _vmParams =
        VaultParameters({
            debtCeiling: 10**9 * BASE_18,
            collateralFactor: uint64(BASE_PARAMS / 2),
            targetHealthFactor: uint64((BASE_PARAMS * 105) / 100),
            interestRate: uint64(BASE_PARAMS / 10),
            liquidationSurcharge: uint64((BASE_PARAMS * 99) / 100),
            maxLiquidationDiscount: uint64(BASE_PARAMS / 10),
            whitelistingActivated: false,
            baseBoost: BASE_PARAMS
        });

    AgTokenSideChainImmutable internal _agToken;
    MockTreasuryImmutable internal _treasury;
    VaultManagerLiquidationBoostImmutable internal _vault;
    IERC20 internal _collateral;
    MockOracle internal _oracle;
    uint8 public decimalToken = 18;

    string constant _NAME = "Angle stablecoin gold";
    string constant _SYMBOL = "agGold";

    function setUp() public override {
        super.setUp();

        _treasury = new MockTreasuryImmutable(ICoreBorrow(coreBorrow));
        _agToken = new AgTokenSideChainImmutable(_NAME, _SYMBOL, address(_treasury));
        _collateral = new MockTokenPermit("Mock", "MCK", decimalToken);
        _oracle = new MockOracle(BASE_18, ITreasury(address(_treasury)));
        _vault = new VaultManagerLiquidationBoostImmutable(
            ITreasury(address(_treasury)),
            _collateral,
            _oracle,
            _vmParams,
            "MockVM"
        );

        vm.startPrank(_GOVERNOR);
        _treasury.setStablecoin(_agToken);
        _treasury.setVaultManagerImpl(_hashVM);
        _treasury.addVaultManager(address(_vault));
        vm.stopPrank();
    }

    // ================================= INITIALIZE ================================

    function testConstructor() public {
        assertEq(_agToken.name(), _NAME);
        assertEq(_agToken.symbol(), _SYMBOL);
        assertEq(_agToken.decimals(), 18);
        assertEq(_agToken.treasury(), address(_treasury));
        assertEq(address(_treasury.core()), address(coreBorrow));
        assertEq(address(_treasury.stablecoin()), address(_agToken));
        assertEq(_treasury.vaultManagerMap(address(_vault)), 1);
        assertEq(address(_treasury.vaultManagerList(0)), address(_vault));
        assertTrue(_agToken.isMinter(address(_vault)));
        vm.expectRevert();
        assertEq(address(_treasury.vaultManagerList(1)), address(0));
    }

    function testAlreadyInitalizeFail() public {
        MockCoreBorrow coreBorrowBis = new MockCoreBorrow();
        AgTokenSideChainImmutable agTokenBis = new AgTokenSideChainImmutable(_NAME, _SYMBOL, address(_treasury));
        _treasury.initialize(ICoreBorrow(coreBorrowBis), agTokenBis);

        assertEq(address(_treasury.core()), address(coreBorrow));
        assertEq(address(_treasury.stablecoin()), address(_agToken));
    }

    // =============================== SETSTABLECOIN ===============================

    function testSetStablecoinWrongCaller() public {
        vm.prank(_alice);
        vm.expectRevert(Treasury.NotGovernor.selector);
        _treasury.setStablecoin(_agToken);
    }

    function testSetStablecoinTwiceFail() public {
        vm.prank(_GOVERNOR);
        vm.expectRevert(TreasuryImmutable.InvalidStablecoin.selector);
        _treasury.setStablecoin(_agToken);
    }

    function testSetWrongStablecoin() public {
        MockTreasuryImmutable treasuryBis = new MockTreasuryImmutable(ICoreBorrow(coreBorrow));

        vm.prank(_GOVERNOR);
        vm.expectRevert(TreasuryImmutable.InvalidStablecoin.selector);
        treasuryBis.setStablecoin(_agToken);
    }

    function testSetStablecoinZeroAddress() public {
        MockTreasuryImmutable treasuryBis = new MockTreasuryImmutable(ICoreBorrow(coreBorrow));

        vm.prank(_GOVERNOR);
        vm.expectRevert();
        treasuryBis.setStablecoin(IAgToken(address(0)));
    }

    // ============================== ADDVAULTMANAGER ==============================

    function testAddVaultManagerSuccess() public {
        IERC20 collateralBis = new MockTokenPermit("Mock Bis", "MCKB", decimalToken + 2);
        MockOracle oracleBis = new MockOracle(BASE_18, ITreasury(address(_treasury)));

        VaultManagerLiquidationBoostImmutable vaultBis = new VaultManagerLiquidationBoostImmutable(
            ITreasury(address(_treasury)),
            collateralBis,
            oracleBis,
            _vmParams,
            "MockVM"
        );
        vm.prank(_GOVERNOR);
        _treasury.addVaultManager(address(vaultBis));

        assertEq(_treasury.vaultManagerMap(address(vaultBis)), 1);
        assertEq(address(_treasury.vaultManagerList(0)), address(_vault));
        assertEq(address(_treasury.vaultManagerList(1)), address(vaultBis));
        assertTrue(_agToken.isMinter(address(vaultBis)));
        vm.expectRevert();
        assertEq(address(_treasury.vaultManagerList(2)), address(0));
    }

    function testAddVaultManagerWrongCaller(address account) public {
        vm.assume(account != _GOVERNOR);
        VaultManagerLiquidationBoostImmutable vaultBis = new VaultManagerLiquidationBoostImmutable(
            ITreasury(address(_treasury)),
            _collateral,
            _oracle,
            _vmParams,
            "MockVM"
        );
        vm.prank(account);
        vm.expectRevert(Treasury.NotGovernor.selector);
        _treasury.addVaultManager(address(vaultBis));
    }

    function testAddIncorrectVaultManagerDifferentFunction() public {
        MockIncorrectVaultManagerLiquidationBoostImmutable vaultBis = new MockIncorrectVaultManagerLiquidationBoostImmutable(
                ITreasury(address(_treasury)),
                _collateral,
                _oracle,
                _vmParams,
                "MockVM"
            );
        vm.prank(_GOVERNOR);
        vm.expectRevert(TreasuryImmutable.InvalidVaultManager.selector);
        _treasury.addVaultManager(address(vaultBis));
    }

    function testAddIncorrectVaultManagerDifferentConstructor() public {
        MockCorrectVaultManagerLiquidationBoostImmutable vaultBis = new MockCorrectVaultManagerLiquidationBoostImmutable(
                ITreasury(address(_treasury)),
                _collateral,
                _oracle,
                _vmParams,
                "MockVM"
            );
        vm.prank(_GOVERNOR);
        vm.expectRevert(TreasuryImmutable.InvalidVaultManager.selector);
        _treasury.addVaultManager(address(vaultBis));
    }

    // ============================== EMPTY FUNCTIONS ==============================
    function testNoImplementationAddMinter() public {
        _treasury.addMinter(_alice);
        assertFalse(_agToken.isMinter(_alice));
    }

    function testNoImplementationRemoveMinter() public {
        _treasury.removeMinter(address(_vault));
        assertTrue(_agToken.isMinter(address(_vault)));
    }

    function testNoImplementationSetTreasury() public {
        MockTreasuryImmutable treasuryBis = new MockTreasuryImmutable(ICoreBorrow(coreBorrow));

        _treasury.setTreasury(address(treasuryBis));
        assertEq(address(_agToken.treasury()), (address(_treasury)));
        assertEq(address(_vault.treasury()), (address(_treasury)));
    }
}
